Objetivo: consultar y mostrar en Modo Caja la cotización USD de AFIP/ARCA (PROD) sin emitir comprobante. Usar solo archivos existentes del proyecto. No tocar src/pdf/** ni src/res/**. No crear .env.

Editar únicamente:

src/afip/RealAFIPBridge.ts (forzar endpoints PROD y exponer fetch de cotización)

src/modules/facturacion/adapters/CompatAfip.ts (asegurar op FEParamGetCotizacion en PROD)

src/modules/facturacion/afipService.ts (función pública de consulta + caché corta)

src/main/ipc.ts (agregar canal cotizacion:get)

Pantalla existente de “Modo Caja” (archivo actual que renderiza Caja): añadir botón/indicador que invoque ipc.invoke('cotizacion:get', …) y muestre resultado

Usa el archivo real de Caja que ya tienen; no crear uno nuevo.

1) RealAFIPBridge.ts

Asegurar selección PROD (sin .env): setear el host WSFEv1 prod dentro del selector actual.

// Dentro del selector de endpoints ya existente:
const WSFE_HOST = 'https://servicios1.afip.gov.ar/wsfev1/service.asmx'; // PROD
// (mantener homo sólo como fallback interno si ya existe; default = PROD)


Exponer método público:

async getCotizacion(monId: string, fchCotiz?: string): Promise<{ monId: string; monCotiz: number; fchCotiz: string }>;


Usar el mismo TA (token/sign/cuit) que la emisión PROD.

Construir SOAP hacia .../FEParamGetCotizacion con MonId y opcional FchCotiz (YYYYMMDD).

Mapear network/timeout/5xx ⇒ Transient; MonId no listado / fecha inválida ⇒ Permanent.

2) CompatAfip.ts

Verificar/ajustar el wrapper de FEParamGetCotizacion para PROD:

Auth (Token/Sign/Cuit), MonId, opcional FchCotiz.

Parsear de ResultGet → MonId, MonCotiz, FchCotiz.

Cuidar namespace (http://ar.gov.afip.dif.FEV1/).

Mantener HOMO solo si el proyecto ya lo tiene, pero default a PROD.

(Referencia de operación: FEParamGetCotizacion). 
servicios1.afip.gov.ar

3) afipService.ts

Agregar helpers dentro del mismo archivo (no crear nuevos):

function resolveMonId(text?: string): 'DOL'|'PES'|'EUR'|string {
  // normaliza: 'USD'/'DOLARES' -> 'DOL'; 'PESOS' -> 'PES'; valida contra FEParamGetTiposMonedas cacheado
}
function prevDiaHabil(yyyymmdd: string): string { /* sáb-dom por ahora */ }


Caché en memoria (simple) por 15 minutos para la última cotización consultada por {monId, modo}.

Nueva función pública para UI:

export async function consultarCotizacionMoneda(options?: {
  monIdText?: string;               // default 'DOL'
  modo?: 'ULTIMA'|'HABIL_ANTERIOR'; // default 'ULTIMA'
  baseDate?: string;                // YYYYMMDD; si falta usar hoy
}): Promise<{ monId: string; monCotiz: number; fchCotiz: string; fuente: 'AFIP/WSFEv1(PROD)'; modo: string }>;


monId = resolveMonId(monIdText || 'DOL') validando contra FEParamGetTiposMonedas (cache 12h). 
18440436026940246557.googlegroups.com

modo==='ULTIMA' ⇒ RealAFIPBridge.getCotizacion(monId) sin FchCotiz.

modo==='HABIL_ANTERIOR' ⇒ fch = prevDiaHabil(baseDate || hoy) y getCotizacion(monId, fch).

Retornar { monId, monCotiz, fchCotiz, fuente: 'AFIP/WSFEv1(PROD)', modo }.

No tocar funciones de emitir CAE.

4) main/ipc.ts

Agregar canal:

ipcMain.handle('cotizacion:get', async (_evt, args?: { monIdText?: string; modo?: 'ULTIMA'|'HABIL_ANTERIOR'; baseDate?: string }) => {
  try {
    return await consultarCotizacionMoneda(args);
  } catch (e:any) {
    // mapear a shape UI amigable
    return { error: true, message: e.message, transient: !!e.isTransient };
  }
});

5) Pantalla “Modo Caja” (archivo existente)

Añadir un widget (sin crear archivos) que:

Muestre dos valores:

“Última oficial AFIP”: llama ipc.invoke('cotizacion:get', { monIdText:'DOL', modo:'ULTIMA' }).

“Hábil anterior”: llama ipc.invoke('cotizacion:get', { monIdText:'DOL', modo:'HABIL_ANTERIOR' }).

Formatee: USD $ {monCotiz.toFixed(2)} (Fch: AAAA-MM-DD) — fuente: AFIP/WSFEv1 (PROD).

Si error && transient, mostrar “No disponible — AFIP/ARCA temporalmente” y ofrecer reintentar.

Guardar último valor OK en el estado de la pantalla para mostrar “(última lectura hh:mm)”.

Criterios de aceptación (rápidos)

En Modo Caja, al abrir:

Se ven dos cifras de dólar: “Última” y “Hábil anterior”, ambas de PRODUCCIÓN.

Cambiando de red a OFF → muestra error transient y permite reintentar (no crashea).

Log de backend indica llamada a:
servicios1.afip.gov.ar/wsfev1/service.asmx?op=FEParamGetCotizacion con MonId='DOL' (y FchCotiz sólo en “Hábil anterior”). 
servicios1.afip.gov.ar

Si MonId no está en catálogo FEParamGetTiposMonedas → error permanente legible. 
18440436026940246557.googlegroups.com

No se modifica nada del flujo de emisión, PDF ni .res.