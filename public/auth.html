<!DOCTYPE html>
<html lang="es" class="h-full bg-gray-900">
<head>
  <meta charset="UTF-8">
  <title>Acceso Administrador</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="h-full overflow-hidden flex items-center justify-center text-white">

<div id="app" class="w-full max-w-md p-6 bg-gray-800 rounded-xl shadow-lg space-y-4">

  <!-- MODAL PERSONALIZADO -->
  <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-800 rounded-lg p-6 max-w-sm w-full mx-4">
      <div id="modal-content" class="text-white text-center">
        <p id="modal-message" class="mb-4"></p>
        <button id="modal-ok" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <div class="text-center">
    <h1 id="form-title" class="text-xl font-bold">Modo Administrador</h1>
    <p id="form-subtitle" class="text-sm text-gray-400 mt-1"></p>
    <div class="mt-3">
      <button id="btnBackToCaja" class="px-3 py-1.5 text-sm bg-emerald-600 rounded hover:bg-emerald-500 font-semibold">‚Üê Volver a Modo Caja</button>
    </div>
  </div>

  <!-- LOGIN FORM -->
  <form id="login-form" class="space-y-4">
    <input type="text" id="login-user" placeholder="Usuario"
           class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring focus:border-blue-400">
    <input type="password" id="login-pass" placeholder="Contrase√±a"
           class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring focus:border-blue-400">
    
    <!-- Checkbox para recordar usuario -->
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <input type="checkbox" id="remember-user" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
        <label for="remember-user" class="text-sm text-gray-300">Recordar usuario</label>
      </div>
      <button type="button" id="clear-remembered" class="text-xs text-gray-400 hover:text-red-400 underline">Limpiar</button>
    </div>
    
    <button type="submit" class="w-full py-2 bg-blue-600 rounded hover:bg-blue-700 font-semibold">Ingresar</button>
    <div class="text-sm text-center">
      <a href="#" id="forgot-link" class="text-blue-400 hover:underline">¬øOlvidaste tu contrase√±a?</a>
    </div>
  </form>

  <!-- SETUP FORM -->
  <form id="setup-form" class="space-y-4 hidden">
    <input type="text" id="setup-user" placeholder="Nuevo usuario"
           class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600">
    <input type="password" id="setup-pass" placeholder="Nueva contrase√±a"
           class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600">
    <input type="text" id="setup-secret" placeholder="Frase secreta (recuperaci√≥n)"
           class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600">
    <button type="submit" class="w-full py-2 bg-green-600 rounded hover:bg-green-700 font-semibold">Crear Admin</button>
  </form>

  <!-- RECOVERY FORM -->
  <div id="recovery-form" class="hidden space-y-4">
    <div class="flex space-x-2 justify-center mb-4">
      <button id="tab-secret" class="px-3 py-1 bg-blue-600 rounded">Frase Secreta</button>
      <button id="tab-email" class="px-3 py-1 bg-gray-700 rounded">Email OTP</button>
    </div>

    <!-- SECRET -->
    <div id="rec-secret" class="space-y-3">
      <input type="text" id="rec-secret-input" placeholder="Frase secreta"
             class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600">
      <input type="password" id="rec-secret-newpass" placeholder="Nueva contrase√±a"
             class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600">
      <button id="btn-secret-reset" class="w-full py-2 bg-green-600 rounded">Resetear</button>
    </div>

    <!-- EMAIL -->
    <div id="rec-email" class="hidden space-y-3">
      <button id="btn-send-otp" class="w-full py-2 bg-blue-600 rounded">Enviar c√≥digo al email</button>
      <input type="text" id="rec-email-otp" placeholder="C√≥digo recibido"
             class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600">
      <input type="password" id="rec-email-newpass" placeholder="Nueva contrase√±a"
             class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600">
      <button id="btn-email-reset" class="w-full py-2 bg-green-600 rounded">Resetear</button>
    </div>

    <div class="text-sm text-center">
      <a href="#" id="back-login" class="text-blue-400 hover:underline">Volver al login</a>
    </div>
  </div>

</div>

<script>
(async () => {
  const loginForm = document.getElementById('login-form');
  const setupForm = document.getElementById('setup-form');
  const recoveryForm = document.getElementById('recovery-form');
  const title = document.getElementById('form-title');
  const subtitle = document.getElementById('form-subtitle');

  // Funciones para modal personalizado
  function showCustomModal(message, callback = null) {
    const modal = document.getElementById('custom-modal');
    const modalMessage = document.getElementById('modal-message');
    const modalOk = document.getElementById('modal-ok');
    
    // Convertir saltos de l√≠nea en <br> para HTML
    modalMessage.innerHTML = message.replace(/\n/g, '<br>');
    modal.classList.remove('hidden');
    
    const handleOk = () => {
      modal.classList.add('hidden');
      modalOk.removeEventListener('click', handleOk);
      if (callback) callback();
    };
    
    modalOk.addEventListener('click', handleOk);
    
    // Tambi√©n cerrar con Escape
    const handleEscape = (e) => {
      if (e.key === 'Escape') {
        handleOk();
        document.removeEventListener('keydown', handleEscape);
      }
    };
    document.addEventListener('keydown', handleEscape);
  }

  // Cargar usuario recordado al iniciar
  // Volver a Modo Caja
  document.getElementById('btnBackToCaja')?.addEventListener('click', async () => {
    try {
      if (window.api && typeof window.api.openView === 'function') {
        await window.api.openView('caja');
        return;
      }
    } catch {}
    // Fallback: navegar directo
    window.location.href = 'caja.html';
  });
  const rememberedUser = localStorage.getItem('rememberedUser');
  if (rememberedUser) {
    document.getElementById('login-user').value = rememberedUser;
    document.getElementById('remember-user').checked = true;
  }

  const isInit = await window.auth.isInitialized();
  if (!isInit) {
    loginForm.classList.add('hidden');
    setupForm.classList.remove('hidden');
    title.textContent = 'Configurar Administrador';
    subtitle.textContent = 'Cree el usuario y contrase√±a';
  }

  loginForm.addEventListener('submit', async e => {
    e.preventDefault();
    const u = document.getElementById('login-user').value.trim();
    const p = document.getElementById('login-pass').value.trim();
    const rememberUser = document.getElementById('remember-user').checked;
    
    // Guardar o limpiar usuario recordado
    if (rememberUser && u) {
      localStorage.setItem('rememberedUser', u);
    } else {
      localStorage.removeItem('rememberedUser');
    }
    
    const res = await window.auth.login({ username: u, password: p });
    if (res.ok) {
      await window.auth.openConfig();
    } else {
      let errorMessage = '';
      let shouldFocusUser = true;
      
      // Mensajes personalizados seg√∫n el tipo de error
      switch (res.reason) {
        case 'locked':
          if (res.unlockAt) {
            const unlockTime = new Date(res.unlockAt);
            const now = new Date();
            const minutesLeft = Math.ceil((unlockTime.getTime() - now.getTime()) / (1000 * 60));
            errorMessage = `üîí Cuenta bloqueada temporalmente\n\n‚è∞ Se desbloquear√° en ${minutesLeft} minutos\n\nüí° Alternativas:\n‚Ä¢ Esperar el desbloqueo autom√°tico\n‚Ä¢ Usar recuperaci√≥n de contrase√±a\n‚Ä¢ Contactar al administrador`;
          } else {
            errorMessage = 'üîí Cuenta bloqueada temporalmente\n\n‚è∞ Intente nuevamente en unos minutos';
          }
          break;
          
        case 'invalid':
          errorMessage = '‚ùå Usuario o contrase√±a incorrectos\n\nüí° Verifique:\n‚Ä¢ El nombre de usuario\n‚Ä¢ La contrase√±a (may√∫sculas/min√∫sculas)\n‚Ä¢ Que no haya espacios extra\n\nüîë Si olvid√≥ su contrase√±a, use la recuperaci√≥n';
          break;
          
        case 'not_initialized':
          errorMessage = '‚ö†Ô∏è Sistema no configurado\n\nüë§ Primero debe crear un usuario administrador\n\nüìù Complete el formulario de configuraci√≥n inicial';
          shouldFocusUser = false;
          break;
          
        default:
          errorMessage = `‚ùå Error de autenticaci√≥n\n\nüîç Detalle: ${res.reason}\n\nüí° Intente nuevamente o contacte soporte`;
      }
      
      showCustomModal(errorMessage, () => {
        // Restaurar foco despu√©s del modal
        if (shouldFocusUser) {
          const userField = document.getElementById('login-user');
          if (userField) {
            userField.focus();
            userField.select();
          }
        }
      });
    }
  });

  // Bot√≥n para limpiar usuario recordado
  document.getElementById('clear-remembered').addEventListener('click', () => {
    localStorage.removeItem('rememberedUser');
    document.getElementById('login-user').value = '';
    document.getElementById('remember-user').checked = false;
  });

  setupForm.addEventListener('submit', async e => {
    e.preventDefault();
    const u = document.getElementById('setup-user').value.trim();
    const p = document.getElementById('setup-pass').value.trim();
    const s = document.getElementById('setup-secret').value.trim();
    try {
      await window.auth.setup({ username: u, password: p, secretPhrase: s });
      showCustomModal('Administrador creado. Ahora puede iniciar sesi√≥n.', () => {
        // En lugar de recargar, cambiar directamente al formulario de login
        setupForm.classList.add('hidden');
        loginForm.classList.remove('hidden');
        title.textContent = 'Modo Administrador';
        subtitle.textContent = 'Ingrese sus credenciales';
        
        // Limpiar el formulario de setup
        document.getElementById('setup-user').value = '';
        document.getElementById('setup-pass').value = '';
        document.getElementById('setup-secret').value = '';
        
        // Enfocar el campo de usuario
        document.getElementById('login-user').focus();
      });
      
    } catch (err) {
      let errorMessage = '';
      
      // Mensajes personalizados para setup
      switch (err.message) {
        case 'weak_password':
          errorMessage = 'üîí Contrase√±a d√©bil\n\nüìã Requisitos m√≠nimos:\n‚Ä¢ Al menos 8 caracteres\n‚Ä¢ Una letra may√∫scula\n‚Ä¢ Un n√∫mero\n\nüí° Ejemplo: Admin1234';
          break;
          
        default:
          errorMessage = `‚ùå Error de configuraci√≥n\n\nüîç Detalle: ${err.message}\n\nüí° Verifique los datos e intente nuevamente`;
      }
      
      showCustomModal(errorMessage, () => {
        // Restaurar foco despu√©s del modal
        const userField = document.getElementById('setup-user');
        if (userField) {
          userField.focus();
          userField.select();
        }
      });
    }
  });

  // Recuperaci√≥n
  document.getElementById('forgot-link').addEventListener('click', e => {
    e.preventDefault();
    loginForm.classList.add('hidden');
    recoveryForm.classList.remove('hidden');
    title.textContent = 'Recuperar Acceso';
    subtitle.textContent = '';
  });

  document.getElementById('back-login').addEventListener('click', e => {
    e.preventDefault();
    recoveryForm.classList.add('hidden');
    loginForm.classList.remove('hidden');
    title.textContent = 'Modo Administrador';
    subtitle.textContent = 'Ingrese sus credenciales';
  });

  // Tabs
  document.getElementById('tab-secret').addEventListener('click', () => {
    document.getElementById('rec-secret').classList.remove('hidden');
    document.getElementById('rec-email').classList.add('hidden');
  });
  document.getElementById('tab-email').addEventListener('click', () => {
    document.getElementById('rec-secret').classList.add('hidden');
    document.getElementById('rec-email').classList.remove('hidden');
  });

  // Reset por frase
  document.getElementById('btn-secret-reset').addEventListener('click', async () => {
    const s = document.getElementById('rec-secret-input').value.trim();
    const np = document.getElementById('rec-secret-newpass').value.trim();
    try {
      await window.auth.resetBySecret({ secretPhrase: s, newPw: np });
      showCustomModal('Contrase√±a cambiada.', () => {
        // Volver al formulario de login
        recoveryForm.classList.add('hidden');
        loginForm.classList.remove('hidden');
        title.textContent = 'Modo Administrador';
        subtitle.textContent = 'Ingrese sus credenciales';
        
        // Limpiar formularios
        document.getElementById('rec-secret-input').value = '';
        document.getElementById('rec-secret-newpass').value = '';
        document.getElementById('rec-email-otp').value = '';
        document.getElementById('rec-email-newpass').value = '';
      });
      
    } catch (err) {
      let errorMessage = '';
      
      // Mensajes personalizados para recuperaci√≥n
      switch (err.message) {
        case 'invalid_secret':
          errorMessage = 'üîë Frase secreta incorrecta\n\nüí° Verifique:\n‚Ä¢ La frase secreta exacta\n‚Ä¢ May√∫sculas y min√∫sculas\n‚Ä¢ Espacios adicionales\n\nüìù Esta frase se configur√≥ al crear el administrador';
          break;
          
        case 'weak_password':
          errorMessage = 'üîí Nueva contrase√±a d√©bil\n\nüìã Requisitos m√≠nimos:\n‚Ä¢ Al menos 8 caracteres\n‚Ä¢ Una letra may√∫scula\n‚Ä¢ Un n√∫mero\n\nüí° Ejemplo: Admin1234';
          break;
          
        default:
          errorMessage = `‚ùå Error de recuperaci√≥n\n\nüîç Detalle: ${err.message}\n\nüí° Verifique los datos e intente nuevamente`;
      }
      
      showCustomModal(errorMessage, () => {
        // Restaurar foco despu√©s del modal
        const secretField = document.getElementById('rec-secret-input');
        if (secretField) {
          secretField.focus();
          secretField.select();
        }
      });
    }
  });

  // Email OTP
  document.getElementById('btn-send-otp').addEventListener('click', async () => {
    try {
      const res = await window.auth.requestOtp();
      showCustomModal('C√≥digo enviado a: ' + res.masked);
    } catch (err) {
      let errorMessage = '';
      
      // Mensajes personalizados para OTP
      switch (err.message) {
        case 'no_email':
          errorMessage = 'üìß Email no configurado\n\n‚öôÔ∏è Para usar recuperaci√≥n por email:\n‚Ä¢ Configure el email SMTP en Configuraci√≥n\n‚Ä¢ O use recuperaci√≥n por frase secreta\n\nüîë Alternativa: Use "Frase Secreta"';
          break;
          
        default:
          errorMessage = `‚ùå Error al enviar c√≥digo\n\nüîç Detalle: ${err.message}\n\nüí° Verifique la configuraci√≥n de email o use frase secreta`;
      }
      
      showCustomModal(errorMessage, () => {
        // Restaurar foco despu√©s del modal
        const otpField = document.getElementById('rec-email-otp');
        if (otpField) {
          otpField.focus();
          otpField.select();
        }
      });
    }
  });

  document.getElementById('btn-email-reset').addEventListener('click', async () => {
    const otp = document.getElementById('rec-email-otp').value.trim();
    const np = document.getElementById('rec-email-newpass').value.trim();
    try {
      await window.auth.resetByOtp({ otp, newPw: np });
      showCustomModal('Contrase√±a cambiada.', () => {
        // Volver al formulario de login
        recoveryForm.classList.add('hidden');
        loginForm.classList.remove('hidden');
        title.textContent = 'Modo Administrador';
        subtitle.textContent = 'Ingrese sus credenciales';
        
        // Limpiar formularios
        document.getElementById('rec-secret-input').value = '';
        document.getElementById('rec-secret-newpass').value = '';
        document.getElementById('rec-email-otp').value = '';
        document.getElementById('rec-email-newpass').value = '';
      });
      
    } catch (err) {
      let errorMessage = '';
      
      // Mensajes personalizados para reset por email
      switch (err.message) {
        case 'invalid_otp':
          errorMessage = 'üî¢ C√≥digo OTP inv√°lido\n\nüí° Verifique:\n‚Ä¢ El c√≥digo de 6 d√≠gitos\n‚Ä¢ Que no haya expirado (10 minutos)\n‚Ä¢ Que no haya espacios extra\n\nüìß Si no recibi√≥ el c√≥digo, solic√≠telo nuevamente';
          break;
          
        case 'weak_password':
          errorMessage = 'üîí Nueva contrase√±a d√©bil\n\nüìã Requisitos m√≠nimos:\n‚Ä¢ Al menos 8 caracteres\n‚Ä¢ Una letra may√∫scula\n‚Ä¢ Un n√∫mero\n\nüí° Ejemplo: Admin1234';
          break;
          
        default:
          errorMessage = `‚ùå Error de recuperaci√≥n\n\nüîç Detalle: ${err.message}\n\nüí° Verifique los datos e intente nuevamente`;
      }
      
      showCustomModal(errorMessage, () => {
        // Restaurar foco despu√©s del modal
        const otpField = document.getElementById('rec-email-otp');
        if (otpField) {
          otpField.focus();
          otpField.select();
        }
      });
    }
  });

})();
</script>
</body>
</html>
