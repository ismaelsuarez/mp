<!doctype html>
<html lang="es">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>MP – Configuración</title>
	<link rel="stylesheet" href="style.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
</head>
<body class="text-slate-200">
    <div class="container">
        <div class="flex items-center justify-between mb-2">
            <h1>TODO-COMPUTACION</h1>
            <div class="flex items-center gap-2">
                <button id="btnOpenLogs" class="px-3 py-1.5 rounded-md bg-slate-700 text-white border-0 hover:bg-slate-600">Abrir log de hoy</button>
                <button id="btnOpenCaja" class="px-4 py-2 rounded-md bg-emerald-600 text-white border-0 hover:bg-emerald-500">Modo Caja</button>
            </div>
        </div>
        <div class="tabs">
            <button class="tab active" data-tab="config">Configuración</button>
            <button class="tab" data-tab="results">Resultados</button>
            <button class="tab" data-tab="history">Historial</button>
            <button class="tab" data-tab="about">Acerca de</button>
        </div>

        <section id="tab-config" class="tab-pane active">
			<form id="configForm" class="form-grid">
				<details class="group mb-4 border border-slate-700 rounded-md">
					<summary class="cursor-pointer px-3 py-2 bg-slate-800 rounded-t-md text-sm font-semibold select-none">
						Mercado Pago
					</summary>
					<div class="p-3 space-y-2">
						<label>Access Token (Mercado Pago) <input id="MP_ACCESS_TOKEN" type="password" /></label>
						<label>ID de usuario (opcional) <input id="MP_USER_ID" /></label>
						<div class="row">
							<button type="button" id="btnTest">Probar conexión</button>
							<span id="testStatus"></span>
						</div>
						<label>Zona horaria <input id="MP_TZ" placeholder="America/Argentina/Buenos_Aires" /></label>
						<label>Hora de inicio <input id="MP_WINDOW_START" placeholder="00:00" /></label>
						<label>Hora de finalización <input id="MP_WINDOW_END" placeholder="23:59" /></label>
						<label>Desde (fecha) <input id="MP_DATE_FROM" placeholder="YYYY-MM-DD" /></label>
						<label>Hasta (fecha) <input id="MP_DATE_TO" placeholder="YYYY-MM-DD" /></label>
						<label class="checkbox">
							<input id="MP_NO_DATE_FILTER" type="checkbox" /> Sin filtro de fechas
						</label>
						<label>Días hacia atrás (por defecto)
							<input id="MP_DAYS_BACK" type="number" min="1" step="1" placeholder="7" />
						</label>
						<label>Campo de fecha <input id="MP_RANGE" placeholder="date_last_updated" /></label>
						<label>Estado (opcional) <input id="MP_STATUS" placeholder="approved,refunded" /></label>
						<label>Límite por página <input id="MP_LIMIT" type="number" min="1" step="1" /></label>
						<label>Páginas máximas <input id="MP_MAX_PAGES" type="number" min="1" step="1" /></label>
					</div>
				</details>


				<details class="group mb-4 border border-slate-700 rounded-md">
					<summary class="cursor-pointer px-3 py-2 bg-slate-800 rounded-t-md text-sm font-semibold select-none">
						Email / SMTP
					</summary>
					<div class="p-3 space-y-2">
						<label>Email para reportes <input id="EMAIL_REPORT" placeholder="correo@dominio.com" /></label>
						<label>Servidor SMTP <input id="SMTP_HOST" placeholder="smtp.gmail.com" /></label>
						<label>Puerto SMTP <input id="SMTP_PORT" type="number" placeholder="587" /></label>
						<label>Usuario SMTP <input id="SMTP_USER" /></label>
						<label>Contraseña SMTP <input id="SMTP_PASS" type="password" /></label>
					</div>
				</details>

				<details class="group mb-4 border border-slate-700 rounded-md">
					<summary class="cursor-pointer px-3 py-2 bg-slate-800 rounded-t-md text-sm font-semibold select-none">
						FTP
					</summary>
					<div class="p-3 space-y-2">
						<label>IP o Host <input id="FTP_IP" placeholder="192.168.0.10" /></label>
						<label>Puerto <input id="FTP_PORT" type="number" placeholder="21" /></label>
						<label class="checkbox"><input id="FTP_SECURE" type="checkbox" /> Usar FTPS (explícito)</label>
						<label>Usuario <input id="FTP_USER" placeholder="usuario" /></label>
						<label>Contraseña <input id="FTP_PASS" type="password" placeholder="********" /></label>
						<label>Carpeta remota <input id="FTP_DIR" placeholder="/reportes" /></label>
						<label>Archivo remoto (DBF) <input id="FTP_FILE" placeholder="transactions-detailed-YYYY-MM-DD.dbf" /></label>
						<div class="row">
							<button type="button" id="btnTestFtp">Probar FTP</button>
							<span id="ftpTestStatus"></span>
						</div>
					</div>
				</details>

				<details class="group mb-4 border border-slate-700 rounded-md">
					<summary class="cursor-pointer px-3 py-2 bg-slate-800 rounded-t-md text-sm font-semibold select-none">
						Automatización
					</summary>
					<div class="p-3 space-y-2">
						<label>Intervalo (segundos)
							<input id="AUTO_INTERVAL_SECONDS" type="number" placeholder="3600" />
						</label>
						
						<div class="mb-3">
							<label class="block text-sm font-medium mb-2">Días habilitados para ejecución automática:</label>
							<div class="grid grid-cols-2 gap-2">
								<label class="flex items-center space-x-2">
									<input id="AUTO_DAYS_MONDAY" type="checkbox" checked />
									<span class="text-sm">Lunes</span>
								</label>
								<label class="flex items-center space-x-2">
									<input id="AUTO_DAYS_TUESDAY" type="checkbox" checked />
									<span class="text-sm">Martes</span>
								</label>
								<label class="flex items-center space-x-2">
									<input id="AUTO_DAYS_WEDNESDAY" type="checkbox" checked />
									<span class="text-sm">Miércoles</span>
								</label>
								<label class="flex items-center space-x-2">
									<input id="AUTO_DAYS_THURSDAY" type="checkbox" checked />
									<span class="text-sm">Jueves</span>
								</label>
								<label class="flex items-center space-x-2">
									<input id="AUTO_DAYS_FRIDAY" type="checkbox" checked />
									<span class="text-sm">Viernes</span>
								</label>
								<label class="flex items-center space-x-2">
									<input id="AUTO_DAYS_SATURDAY" type="checkbox" checked />
									<span class="text-sm">Sábado</span>
								</label>
								<label class="flex items-center space-x-2">
									<input id="AUTO_DAYS_SUNDAY" type="checkbox" checked />
									<span class="text-sm">Domingo</span>
								</label>
							</div>
						</div>
						
						<!-- Rangos horarios por día (opcional) -->
						<div class="mb-3">
							<label class="block text-sm font-medium mb-2">Rangos horarios por día (opcional)</label>
							<div class="grid grid-cols-1 md:grid-cols-2 gap-3">
								<div class="flex items-center gap-2"><span class="w-24 text-sm">Lunes</span><input id="AUTO_FROM_MONDAY" type="time" class="w-28" /><span class="text-sm">a</span><input id="AUTO_TO_MONDAY" type="time" class="w-28" /></div>
								<div class="flex items-center gap-2"><span class="w-24 text-sm">Martes</span><input id="AUTO_FROM_TUESDAY" type="time" class="w-28" /><span class="text-sm">a</span><input id="AUTO_TO_TUESDAY" type="time" class="w-28" /></div>
								<div class="flex items-center gap-2"><span class="w-24 text-sm">Miércoles</span><input id="AUTO_FROM_WEDNESDAY" type="time" class="w-28" /><span class="text-sm">a</span><input id="AUTO_TO_WEDNESDAY" type="time" class="w-28" /></div>
								<div class="flex items-center gap-2"><span class="w-24 text-sm">Jueves</span><input id="AUTO_FROM_THURSDAY" type="time" class="w-28" /><span class="text-sm">a</span><input id="AUTO_TO_THURSDAY" type="time" class="w-28" /></div>
								<div class="flex items-center gap-2"><span class="w-24 text-sm">Viernes</span><input id="AUTO_FROM_FRIDAY" type="time" class="w-28" /><span class="text-sm">a</span><input id="AUTO_TO_FRIDAY" type="time" class="w-28" /></div>
								<div class="flex items-center gap-2"><span class="w-24 text-sm">Sábado</span><input id="AUTO_FROM_SATURDAY" type="time" class="w-28" /><span class="text-sm">a</span><input id="AUTO_TO_SATURDAY" type="time" class="w-28" /></div>
								<div class="flex items-center gap-2"><span class="w-24 text-sm">Domingo</span><input id="AUTO_FROM_SUNDAY" type="time" class="w-28" /><span class="text-sm">a</span><input id="AUTO_TO_SUNDAY" type="time" class="w-28" /></div>
							</div>
							<p class="text-xs text-slate-400 mt-1">Si el rango está vacío, se considera todo el día. Si el fin es menor que el inicio, se interpreta como rango nocturno (p. ej. 22:00 a 02:00).</p>
						</div>
						
						<div class="row">
							<button type="button" id="btnAutoStart">Activar</button>
							<button type="button" id="btnAutoStop">Desactivar</button>
							<span id="autoStatus"></span>
						</div>
					</div>
				</details>

				<details class="group mb-4 border border-slate-700 rounded-md">
					<summary class="cursor-pointer px-3 py-2 bg-slate-800 rounded-t-md text-sm font-semibold select-none">
						Seguridad
					</summary>
					<div class="p-3 space-y-2">
						<label>Contraseña actual <input id="current-password" type="password" placeholder="Ingrese su contraseña actual" /></label>
						<label>Nueva contraseña <input id="new-password" type="password" placeholder="Mínimo 8 caracteres, 1 mayúscula, 1 número" /></label>
						<label>Confirmar nueva contraseña <input id="confirm-password" type="password" placeholder="Repita la nueva contraseña" /></label>
						<label>Nuevo usuario (opcional) <input id="new-username" placeholder="Dejar vacío para mantener el actual" /></label>
						<label>Nueva frase secreta (opcional) <input id="new-secret-phrase" placeholder="Dejar vacío para mantener la actual" /></label>
						<div class="row">
							<button type="button" id="btnChangePassword">Cambiar contraseña</button>
							<span id="passwordChangeStatus"></span>
						</div>
					</div>
				</details>

				<details class="group mb-4 border border-slate-700 rounded-md">
					<summary class="cursor-pointer px-3 py-2 bg-slate-800 rounded-t-md text-sm font-semibold select-none">
						🚨 Notificaciones de Error
					</summary>
					<div class="p-3 space-y-3">
						<div class="flex items-center space-x-2">
							<input type="checkbox" id="error-notifications-enabled" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
							<label for="error-notifications-enabled" class="text-sm">Habilitar notificaciones de error por email</label>
						</div>
						
						<div class="grid grid-cols-2 gap-4">
							<label class="text-sm">
								Mínimo errores antes de notificar
								<input id="min-errors-before-notify" type="number" min="1" max="10" class="w-full px-2 py-1 bg-gray-700 border border-gray-600 rounded text-sm" />
							</label>
							<label class="text-sm">
								Tiempo entre notificaciones (minutos)
								<input id="min-time-between-notifications" type="number" min="15" max="1440" class="w-full px-2 py-1 bg-gray-700 border border-gray-600 rounded text-sm" />
							</label>
						</div>

						<div class="bg-gray-800 p-3 rounded text-sm">
							<div class="flex justify-between items-center mb-2">
								<span class="font-semibold">📊 Estado Actual:</span>
								<button type="button" id="btnRefreshErrorSummary" class="text-xs text-blue-400 hover:text-blue-300">Actualizar</button>
							</div>
							<div id="error-summary" class="space-y-1 text-xs">
								<div>• Errores totales: <span id="total-errors">-</span></div>
								<div>• Grupos activos: <span id="active-groups">-</span></div>
								<div>• Notificaciones enviadas: <span id="notifications-sent">-</span></div>
							</div>
						</div>

						<div class="flex space-x-2">
							<button type="button" id="btnSaveErrorNotifications" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded">
								💾 Guardar Configuración
							</button>
							<button type="button" id="btnClearOldErrors" class="px-3 py-1 bg-yellow-600 hover:bg-yellow-700 text-white text-sm rounded">
								🧹 Limpiar Errores Antiguos
							</button>
							<button type="button" id="btnResetErrorNotifications" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded">
								🔄 Resetear Todo
							</button>
						</div>
						
						<div id="error-notifications-status" class="text-sm"></div>
					</div>
				</details>

				<!-- Acciones principales (debajo de todas las secciones) -->
				<div class="actions-row mt-4">
					<button type="button" id="btnLoad">Cargar configuración</button>
					<button type="button" id="btnSave">Guardar configuración</button>
					<button type="button" id="btnGenerate">Generar reporte</button>
					<button type="button" id="btnSendDbfFtp">Enviar DBF por FTP</button>
					<button type="button" id="btnClearFtpHash" title="Limpiar hash FTP para forzar próximo envío">Limpiar Hash FTP</button>
				</div>
			</form>
            <h3>Vista previa (no sensible)</h3>
            <pre id="preview"></pre>
        </section>

        <section id="tab-about" class="tab-pane">
			<p><strong>Información de contacto por fallas</strong></p>
			<p>Servicio técnico – Todo-Computación</p>
			<ul>
				<li>Teléfono: 0261 4201555 int. 2</li>
				<li>WhatsApp: 26154669355</li>
				<li>Email: <a href="mailto:pc@tcmza.com.ar">pc@tcmza.com.ar</a></li>
			</ul>
			<div class="mt-4 text-sm text-slate-300">
				<span class="font-semibold">Versión instalada:</span>
				<span id="app-version">-</span>
			</div>
        </section>

        <section id="tab-results" class="tab-pane">
			<div class="filters">
				<div class="row"><strong>Filtros</strong></div>
				<div class="row">
                <input id="filter_from" placeholder="Desde (YYYY-MM-DD)" />
                <input id="filter_to" placeholder="Hasta (YYYY-MM-DD)" />
                <select id="filter_status">
                    <option value="">Todos</option>
                    <option value="approved">approved</option>
                    <option value="refunded">refunded</option>
                    <option value="cancelled">cancelled</option>
                </select>
                <input id="quick_search" placeholder="Buscar por texto..." />
                <button id="btnGenerateRange">Generar (rango)</button>
                <button id="btnResetFilters" title="Restablecer filtros">Reset</button>
				</div>
			</div>
            <div class="row">
                <div class="summary">
                    <strong>Ingresos:</strong> <span id="summaryIncomes">0.00</span>
                    <strong class="ml-4">Devoluciones:</strong> <span id="summaryRefunds">0.00</span>
                    <strong class="ml-4">Neto:</strong> <span id="summaryTotal">0.00</span>
                </div>
                <div class="ml-auto">
                    <label for="pageSize">Filas por página</label>
                    <select id="pageSize">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <button id="btnExportCSV" title="Exportar CSV (curado)">CSV</button>
                <button id="btnExportXLSX" title="Exportar Excel (full)">XLSX</button>
                <button id="btnExportDBF" title="Exportar DBF (detalle)">DBF</button>
                <button id="btnExportJSON" title="Exportar resumen JSON">JSON</button>
                <button id="btnSendEmail" title="Enviar por email los archivos del día">Enviar por email</button>
            </div>
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>ID pago</th>
                        <th>Estado</th>
                        <th>Monto</th>
                        <th>Fecha</th>
                        <th>Método de pago</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="row">
                <button id="prevPage">Prev</button>
                <span id="pageInfo"></span>
                <button id="nextPage">Next</button>
            </div>
        </section>

        <section id="tab-history" class="tab-pane">
            <div class="row">
                <button id="btnRefreshHistory">Actualizar historial</button>
                <button id="btnOpenOutDir">Abrir carpeta de reportes</button>
            </div>
            <ul id="historyList"></ul>
        </section>
    </div>
    <div id="toast" class="fixed bottom-4 right-4 hidden px-4 py-2 rounded bg-slate-800 border border-slate-700"></div>
    <script>
    document.getElementById('btnOpenCaja')?.addEventListener('click', async () => {
        console.log('[UI] Modo Caja: click capturado');
        try {
            const toast = document.getElementById('toast');
            if (toast) { toast.textContent = 'Abriendo Modo Caja...'; toast.classList.remove('hidden'); setTimeout(()=>toast.classList.add('hidden'), 1500); }
        } catch {}
        try {
            if (window.api && typeof window.api.openView === 'function') {
                console.log('[UI] Llamando window.api.openView("caja")');
                await window.api.openView('caja');
                console.log('[UI] openView resuelto');
                return;
            }
        } catch {}
        // Fallback directo por si IPC no está disponible en dev
        console.warn('[UI] Fallback: navegando directo a caja.html');
        window.location.href = 'caja.html';
    });
    document.getElementById('btnOpenLogs')?.addEventListener('click', async () => {
        if (window.api && typeof window.api.openTodayLog === 'function') {
            await window.api.openTodayLog();
        }
    });
    // Mostrar versión instalada
    (async () => {
        try {
            if (window.api && typeof window.api.getAppVersion === 'function') {
                const res = await window.api.getAppVersion();
                const el = document.getElementById('app-version');
                if (el && res && res.version) el.textContent = res.version;
            }
        } catch {}
    })();
    </script>
    <script src="../dist/src/renderer.js"></script>
</body>
</html>
