<!doctype html>
<html lang="es">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>MP – Modo Caja</title>
	<link rel="stylesheet" href="style.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
    /* Ajustes compactos para 400x300 */
    .container{max-width:480px}
    .table-container { overflow-x: auto; }
    .compact-table { font-size: 11.7px; }
    .compact-table th, .compact-table td { padding: 2px 4px; }
    /* Espaciado para separar el contenido del footer */
    main { margin-bottom: 80px; }
    </style>
</head>
<body class="text-slate-200">
	<nav class="bg-slate-800 border-b border-slate-700">
    <div class="container flex items-center justify-between py-2">
        <div class="flex items-center gap-4">
            <button class="tab" data-tab="home" title="Inicio">
                <img src="./icons/home.png" alt="Inicio" class="w-8 h-8 rounded-full"/>
            </button>
            <button class="tab" data-tab="table" title="Movimientos">
                <img src="./icons/mp.png" alt="Movimientos" class="w-8 h-8 rounded-full"/>
            </button>
            <button class="tab" data-tab="fact" title="Facturas">
                <img src="./icons/peso.png" alt="Facturas" class="w-8 h-8 rounded-full"/>
            </button>
        </div>
        <button id="btnGoConfig" title="Config">
            <img src="./icons/settings.png" alt="Config" class="w-8 h-8 rounded-full"/>
        </button>
    </div>
	</nav>

    <main class="container mt-2">
		<section id="pane-home" class="tab-pane" style="display:block;">
            <div id="cajaLogs" class="bg-black border border-slate-600 rounded-md p-3 h-28 overflow-auto font-mono text-sm shadow-inner"></div>
		</section>

		<section id="pane-table" class="tab-pane" style="display:none;">
            <div class="table-container border border-slate-700 rounded-md">
                <table class="min-w-full compact-table">
                    <thead class="bg-slate-800">
						<tr>
                            <th class="text-left">ID</th>
                            <th class="text-left">Estado</th>
                            <th class="text-left">Monto</th>
                            <th class="text-left">Fecha/hora</th>
						</tr>
					</thead>
                    <tbody id="cajaTableBody"></tbody>
				</table>
			</div>
		</section>

        <section id="pane-fact" class="tab-pane" style="display:none;">
            <div class="table-container border border-slate-700 rounded-md">
                <table class="min-w-full compact-table">
                    <thead class="bg-slate-800">
                        <tr>
                            <th class="text-left">Tipo</th>
                            <th class="text-left">PV-Nro</th>
                            <th class="text-left">CAE</th>
                            <th class="text-left">Fecha/hora</th>
                        </tr>
                    </thead>
                    <tbody id="cajaFactTableBody"></tbody>
                </table>
            </div>
        </section>
	</main>

    <!-- Footer e indicadores automáticos ocultados por pedido del cliente -->

    <script>
    const ipcRenderer = (window.api && window.api.facturacion && window.api.facturacion.getCotizacionMoneda) ? { invoke: (ch, args)=> window.api.facturacion.getCotizacionMoneda(args) } : null;
    const pill = document.getElementById('pillDol');
    const pillText = document.getElementById('pillDolText');
    const pillState = document.getElementById('pillDolState');
    const btnRefresh = document.getElementById('pillDolRefresh');
    const fmt = (n)=> new Intl.NumberFormat('es-AR',{minimumFractionDigits:2, maximumFractionDigits:2}).format(n);
    function setState(kind){
        pillState.className = 'inline-block w-2 h-2 rounded-full ' + (kind==='ok' ? 'bg-emerald-500' : kind==='warn' ? 'bg-amber-500' : 'bg-slate-500');
    }
    async function fetchDol(){
        try {
            if (!ipcRenderer) return;
            console.log('[caja] consultando DOL (última y hábil anterior)...');
            const ult = await ipcRenderer.invoke('cotizacion:get', { monIdText: 'DOL', modo: 'ULTIMA' });
            const hab = await ipcRenderer.invoke('cotizacion:get', { monIdText: 'DOL', modo: 'HABIL_ANTERIOR' });
            if (ult && typeof ult.monCotiz === 'number' && ult.monCotiz > 0){
                const MonCotiz = ult.monCotiz; const FchCotiz = ult.fchCotiz;
                const hhmm = new Date().toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
                const seg = (hab && hab.monCotiz) ? ` | Hábil ant: ${fmt(hab.monCotiz)}` : '';
                pillText.textContent = `Dólar (AFIP) = ${fmt(MonCotiz)} — ${hhmm}${seg}`;
                setState('ok'); pill.classList.remove('hidden');
                localStorage.setItem('dol:last', JSON.stringify({ v:MonCotiz, t:Date.now(), f:FchCotiz }));
            } else {
                console.warn('[caja] cotización DOL falló', (ult && (ult.error || ult.message)) || 'sin datos');
                const cached = localStorage.getItem('dol:last');
                if (cached){
                    const o = JSON.parse(cached);
                    pillText.textContent = `Dólar (AFIP) = ${fmt(o.v)} — último`;
                    setState('warn'); pill.classList.remove('hidden');
                } else {
                    pillText.textContent = `Dólar (AFIP) = -- — --:--`;
                    setState('idle'); pill.classList.remove('hidden');
                }
            }
        } catch {
            console.warn('[caja] error inesperado consultando DOL');
            setState('warn'); pill.classList.remove('hidden');
        }
    }
    btnRefresh?.addEventListener('click', fetchDol);
    // al iniciar: mostrar cache si hay y disparar fetch inmediato
    (function init(){
        try {
            const cached = localStorage.getItem('dol:last');
            if (cached){ const o = JSON.parse(cached); pillText.textContent = `Dólar (AFIP) = ${fmt(o.v)} — cache`; setState('warn'); pill.classList.remove('hidden'); }
        } catch {}
        fetchDol();
        setInterval(fetchDol, 10*60*1000);
    })();
    </script>
    <script src="../dist/src/caja.js"></script>
</body>
</html>
